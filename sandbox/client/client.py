import configparser
import logging
from dataclasses import dataclass
from urllib.parse import urljoin

import click
import requests


@dataclass
class Config:
    api: str

    @staticmethod
    def get_config():
        config = configparser.ConfigParser()
        config.read("config.ini")
        logging.debug(dict(config["default"]))
        return Config(**dict(config["default"]))


@click.command(help="send malware file for analysis")
@click.argument("path", type=click.Path(exists=True))
def send(path):
    config = Config.get_config()
    with open(path) as f:
        logging.info("Sending malware sample for analysis")
        r = requests.post(urljoin(config.api, "upload"), files={"file": f})
        if r.ok:
            logging.info("Sent successful")
        else:
            logging.error("Some error in sending")


@click.group()
def main():
    logging.basicConfig(
        level=logging.DEBUG,
        format="[%(asctime)s][%(levelname)s] %(message)s",
        handlers=[logging.StreamHandler()],
    )


main.add_command(send)

if __name__ == "__main__":
    main()
