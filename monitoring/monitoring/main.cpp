#include "networkmon/tcp-table-test.h"
#include "procmon/Procmon.cpp"
#include "regshot/RegShot.h"
#include "etw/etw.h"
#include "apimon/apimon.h"
#include <cstdlib>
#include <thread>
#include <direct.h>


int main(int argc, char** argv)
{
	// usage: monitoring.exe <log-folder> <malware-path>

	// change directory to argv
	if(argc >= 2)
		_chdir(argv[1]);

	// init variables
	Procmon procmon(R"(procmon.out)");
	vector <pair<HKEY, wstring>> keys = {
		{ HKEY_CURRENT_USER, L"HKEY_CURRENT_USER"}, 
		{ HKEY_CLASSES_ROOT,L"HKEY_CLASSES_ROOT" },
		{ HKEY_LOCAL_MACHINE,L"HKEY_LOCAL_MACHINE" },
		{ HKEY_USERS ,L"HKEY_USERS" },
		{ HKEY_CURRENT_CONFIG, L"HKEY_CURRENT_CONFIG"}
	};
	ETW etw;
	NetworkMon networkmon;
	RegShot* r = new RegShot(keys);
	Apimon apimon("apimon");

	// start tasks
	cout << "Registry snapshot before running malware" << endl;
	r->takeSnapShot("regshot_before");

	cout << "Network TCP Table snapshot before running malware" << endl;
	networkmon.save("network_before");

	system("netsh trace start traceFile=log.etl capture=yes");
	cout << "Network capture started" << endl;;

	etw.start();
	procmon.start();
	thread th(&Apimon::start, apimon);
	cout << "Analysis started" << endl;;

	// the program to run
	if (argc == 3) {
		string malware = "start " + string(argv[2]);
		system(malware.c_str());
	}

	// waiting time
	Sleep(5000);

	// cleanups
	cout << "Analysis stopped" << endl;
	procmon.stop();
	etw.stop();
	apimon.stop();
	th.join();

	system("netsh trace stop");
	cout << "Network capture stopped" << endl;

	system("etl2pcapng.exe log.etl log.pcapng");

	cout << "Network TCP Table snapshot after running malware" << endl;
	networkmon.save("network_after");

	cout << "Registry snapshot after running malware" << endl;
	r->takeSnapShot("regshot_after");
	delete r;
	system("pause");
	return 0;
}
