import logging
from pathlib import Path
from subprocess import PIPE, Popen

from parsing_IOC.ExtractIOC import ExtractIOC
from static_analysis.BasicStaticAnalysis import BasicStaticAnalysis
from static_analysis.DetectAntiTechniques import DetectAntiTechniques
from static_analysis.PackerDetection import PackerDetection
from static_analysis.PEFileInfo import PEFileInfo
from static_analysis.Report import Report
from static_analysis.signature_based_detection import SignatureBasedDetection

# needed in DetectAntiTechniques and PackerDetection
report = Report("static-analysis.txt")

logging.basicConfig(
    level=logging.DEBUG,
    format="[%(asctime)s][%(levelname)s] %(message)s",
    handlers=[logging.StreamHandler()],
)

# Malacious process that got detected must be stored in files and all these file names should be stored in "FilesToBeAnalysed" file

files_dir = Path("files")

files = files_dir.rglob("*")

output_dir = Path("results")
output_dir.mkdir(parents=True, exist_ok=True)

process_dir = output_dir / "parsed_dumps" / "process"
base_dir = output_dir / "static_analysis"

extract_ioc = ExtractIOC()
extract_ioc.run(log_dir="logs", output_dir=output_dir)

for file in files:
    file_name = file.name.split(".")[0]

    file_directory = base_dir / file_name
    file_directory.mkdir(parents=True, exist_ok=True)

    with open(process_dir / file.name, "r") as api_log:
        data = api_log.read().strip().split("\n\n")

    ApiHooks = []
    ApiCalls = set()

    for apicall in data:
        apicall = apicall.split("\n")
        if apicall[0] != "":
            ApiHooks.append(apicall)
            ApiCalls.add(apicall[0])

    # DETECT ANTI TECHNIQUES

    detect_anti_techniques = DetectAntiTechniques(files_dir / file.name, report)
    detect_anti_techniques.run(ApiCalls, ApiHooks)

    # BASIC STATIC ANALYSIS

    basic_static_analysis = BasicStaticAnalysis(files_dir / file.name)
    basic_static_analysis.run(file_directory / "basic_static_analysis.txt")

    # PACKER DETECTION

    packer_detection = PackerDetection(files_dir / file.name, report)
    packer_detection.run()

    # LOGGING TO THE FILE

    with open(file_directory / "report.txt", "w") as report_file:
        report_file.write("[DETECTIONS]\n\n")

        for detection in report.GetDetections():
            report_file.write(detection + "\n")

        report_file.write("\n[SUSPICIONS]\n\n")

        for suspicion in report.GetSuspicions():
            report_file.write(suspicion + "\n")

    # PEFILE INFO

    pe_file_info = PEFileInfo(files_dir / file.name)
    pe_file_info.run(file_directory / "pe_file_info.txt")

    # # Signature Based Detection using clamAV and Yara

    signature = SignatureBasedDetection(str(files_dir / file.name))

    # SIGNATURE BASED DETECTION
    signature.run(file_directory / "signature_based_analysis.txt")

logging.info(f"Analysis is done, you can find the files at {output_dir.absolute()}")
